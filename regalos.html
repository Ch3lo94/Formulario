<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Regalos</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fafafa; padding:30px; text-align:center; }
    h1 { color:#333; }
    #regalos { margin-top:30px; display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
    .item { border:2px solid transparent; padding:15px; width:200px; cursor:pointer; border-radius:12px;
           background:white; box-shadow:0 2px 6px rgba(0,0,0,0.1); transition:0.3s; text-align:center; }
    .item img { width:100%; height:160px; object-fit:cover; border-radius:8px; }
    .item:hover { transform:scale(1.03); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
    .selected { border-color:#4CAF50; transform:scale(1.05); }
    button { margin-top:30px; padding:15px 40px; background:#4CAF50; color:white; border:none; border-radius:6px;
             font-size:16px; cursor:pointer; transition:0.2s; }
    button:hover { background:#43a047; }
    #message { margin-top:18px; color:#555; }
    .notice { background:#fff3cd; padding:12px; border-radius:8px; margin:15px auto; max-width:720px; color:#856404; }
    .error { background:#f8d7da; color:#721c24; }
    a.link { color:#1565c0; text-decoration:none; font-weight:bold; }
  </style>
</head>
<body>

  <h1>Eleg칤 tu regalo 游꾸</h1>

  <div id="info" class="notice" style="display:none;"></div>

  <div id="regalos">Cargando regalos...</div>

  <br>

  <button onclick="enviarSeleccion()">Enviar selecci칩n</button>

  <div id="message"></div>

  <script>
    // Cambi치 esta URL por la tuya si quer칠s mostrarla (tu webapp)
    const WEBAPP_BASE = "https://script.google.com/macros/s/AKfycbwY5TFocek-mo2wHTNGDp8LF_1uGKZvS6Ear6kPErZFz8R2Fl9MuDKx885b_RFufvWI/exec";

    const params = new URLSearchParams(window.location.search);
    const email = params.get("email");
    let regaloSeleccionado = null;
    let regalosLista = [];

    function showInfo(msg, isError) {
      const info = document.getElementById("info");
      info.style.display = "block";
      info.className = isError ? "notice error" : "notice";
      info.innerHTML = msg;
    }

    function showMessage(msg) {
      const m = document.getElementById("message");
      m.innerText = msg;
    }

    // Verificar que google.script.run exista (estamos dentro de la WebApp)
    if (typeof google === 'undefined' || !google.script || !google.script.run) {
      // No estamos en entorno Apps Script -> explicar al usuario
      document.getElementById("regalos").innerHTML = `
        <div style="max-width:700px;margin:auto;">
          <p style="color:#b71c1c;font-weight:bold;">No se pudo cargar: la p치gina debe abrirse desde la Web App de Google Apps Script.</p>
          <p>Us치 esta URL (ejemplo) y agreg치 <code>?page=regalos&email=tu@email.com</code> al final:</p>
          <p><a class="link" href="${WEBAPP_BASE}" target="_blank">${WEBAPP_BASE}</a></p>
          <p>Ejemplo final:<br><code>${WEBAPP_BASE}?page=regalos&email=ejemplo@dominio.com</code></p>
        </div>`;
    } else {
      // Llamar al servidor para traer regalos
      google.script.run
        .withSuccessHandler(function(lista) {
          try {
            if (!Array.isArray(lista) || lista.length === 0) {
              document.getElementById("regalos").innerHTML = "<p>No hay regalos disponibles por ahora.</p>";
              return;
            }
            regalosLista = lista;
            renderRegalos(lista);
          } catch (e) {
            document.getElementById("regalos").innerText = "Error al procesar los regalos.";
            console.error(e);
          }
        })
        .withFailureHandler(function(err) {
          document.getElementById("regalos").innerText = "Error al cargar regalos desde el servidor.";
          console.error("getRegalos failed:", err);
          showInfo("Error al obtener los regalos desde el servidor. Revisa los permisos de despliegue o los logs en Apps Script.", true);
        })
        .getRegalos();
    }

    function renderRegalos(lista) {
      const cont = document.getElementById("regalos");
      cont.innerHTML = "";
      lista.forEach(reg => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <img src="${reg.imagen || 'https://via.placeholder.com/300x160?text=Sin+imagen'}" alt="Regalo">
          <h3>${escapeHtml(reg.nombre || '')}</h3>
          <p>${escapeHtml(reg.descripcion || '')}</p>
        `;
        div.onclick = () => seleccionar(div, reg.id);
        cont.appendChild(div);
      });
    }

    function seleccionar(element, id) {
      document.querySelectorAll(".item").forEach(e => e.classList.remove("selected"));
      element.classList.add("selected");
      regaloSeleccionado = id;
      showMessage(""); // limpiar mensajes
    }

    function enviarSeleccion() {
      if (!regaloSeleccionado) {
        showMessage("Por favor, eleg칤 un regalo antes de enviar.");
        return;
      }
      if (!email) {
        showInfo("No se detect칩 el email en la URL. Asegurate de abrir la WebApp con el par치metro <code>?page=regalos&email=tu@correo</code>.", true);
        return;
      }

      showMessage("Enviando selecci칩n...");
      google.script.run
        .withSuccessHandler(function(res) {
          try {
            if (res && res.success) {
              window.location.href = "exit.html";
            } else {
              const err = (res && res.error) ? res.error : "error_desconocido";
              showInfo("No se pudo guardar la selecci칩n: " + err, true);
            }
          } catch (e) {
            console.error(e);
            showInfo("Ocurri칩 un error al procesar la respuesta del servidor.", true);
          }
        })
        .withFailureHandler(function(err) {
          console.error("guardarRespuesta failed:", err);
          showInfo("Error al comunicarse con el servidor. Revisa permisos o logs.", true);
        })
        .guardarRespuesta(email, [regaloSeleccionado]);
    }

    // Peque침a funci칩n para evitar inyecci칩n visual
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
  </script>

</body>
</html>
